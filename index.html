<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future Seeds Program Data Collector</title>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Leaflet CSS and JS for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        body {
            background: #174532;
            padding: 2rem 1rem;
            display: flex;
            justify-content: center;
        }
        .card {
            max-width: 1600px;
            width: 100%;
            background: #f6f9ed;
            border-radius: 36px;
            box-shadow: 0 25px 50px -12px #0b2f1a;
            border: 3px solid #dbb15a;
        }
        .header {
            background: #1a5830;
            color: white;
            padding: 2rem 2.5rem;
            background: linear-gradient(145deg, #1f5c33, #124325);
            border-bottom: 5px solid #f5c542;
        }
        .header h1 {
            font-weight: 700;
            font-size: 2.6rem;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .header h1 span {
            background: #f0c34a;
            font-size: 1.2rem;
            padding: 0.4rem 1.8rem;
            border-radius: 60px;
            color: #1f4a1f;
            font-weight: 700;
        }
        .guide-toggle {
            background: #3a7b4a;
            color: white;
            padding: 0.8rem 2.5rem;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #f5c542;
        }
        .guide-toggle:hover {
            background: #469657;
        }
        .guide-panel {
            background: #f4fbe7;
            padding: 2rem 2.5rem;
            border-bottom: 3px solid #c5aa5a;
            display: none;
        }
        .guide-panel.show {
            display: block;
        }
        .guide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }
        .guide-step {
            background: white;
            padding: 1.5rem;
            border-radius: 24px;
            border-left: 8px solid #3c8d4a;
            box-shadow: 0 4px 0 #a1b473;
        }
        .guide-step h3 {
            color: #1e621e;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        .guide-step ul {
            padding-left: 1.5rem;
            color: #2f4d2f;
        }
        .guide-step li {
            margin: 0.5rem 0;
        }
        .region-bar {
            background: #31754a;
            padding: 1rem 2.5rem;
            display: flex;
            align-items: center;
            gap: 2.5rem;
            flex-wrap: wrap;
            border-bottom: 2px solid #edc150;
        }
        .selector-group {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .selector-group label {
            font-weight: 700;
            color: #fffde4;
            text-transform: uppercase;
            font-size: 0.95rem;
        }
        .selector-group select {
            background: white;
            border: none;
            border-radius: 60px;
            padding: 12px 36px 12px 22px;
            font-size: 1.1rem;
            font-weight: 600;
            min-width: 280px;
            border: 3px solid #fdcd5a;
            cursor: pointer;
        }
        .location-options {
            display: flex;
            gap: 15px;
            background: #22633a;
            padding: 0.6rem 1.8rem;
            border-radius: 60px;
            align-items: center;
        }
        .location-options label {
            color: #fcf1b5;
            font-weight: 600;
        }
        .location-options select {
            background: #fef7d6;
            border-radius: 40px;
            padding: 8px 28px 8px 16px;
            border: 2px solid #eeb844;
            font-weight: 600;
        }
        .content {
            padding: 2.5rem;
        }
        .current-conditions {
            background: #deecbf;
            border-radius: 32px;
            padding: 1.5rem 2.5rem;
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            border-left: 15px solid #e0aa3a;
            border-right: 2px solid #b59849;
        }
        .species-info {
            font-size: 1.4rem;
            font-weight: 700;
            color: #174d17;
        }
        .month-indicator {
            background: #3e823e;
            padding: 0.6rem 2.2rem;
            border-radius: 60px;
            color: #ffffc7;
            font-weight: 700;
            font-size: 1.2rem;
        }
        .stats-panel {
            background: #f0e6c5;
            border-radius: 60px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            color: #1f4f1f;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .stat-value {
            background: #528a44;
            color: white;
            padding: 0.2rem 0.8rem;
            border-radius: 30px;
        }
        .map-section {
            margin-bottom: 2rem;
            background: #e8f0da;
            border-radius: 32px;
            padding: 1.5rem;
            border: 3px solid #c1aa5a;
        }
        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .map-header h3 {
            color: #1e611e;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .map-toggle {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .map-btn {
            background: white;
            border: 3px solid #5e8f4a;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            color: #265226;
        }
        .map-btn.active {
            background: #3d973d;
            border-color: #f5bc3c;
            color: white;
        }
        .map-btn.location-btn {
            background: #4a90e2;
            border-color: #2a5080;
            color: white;
        }
        .map-btn.location-btn:hover {
            background: #5a9ef2;
        }
        #map {
            height: 300px;
            border-radius: 24px;
            border: 3px solid #a5b87a;
            margin-bottom: 1rem;
            display: none;
        }
        #map.show {
            display: block;
        }
        .coord-display {
            background: #f4fbe4;
            padding: 1rem;
            border-radius: 50px;
            display: flex;
            gap: 2rem;
            justify-content: center;
            flex-wrap: wrap;
            border: 2px solid #99aa66;
        }
        .coord-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .coord-item label {
            font-weight: 700;
            color: #1b581b;
        }
        .coord-item input {
            background: white;
            border: 2px solid #bcc987;
            border-radius: 40px;
            padding: 8px 16px;
            width: 120px;
            font-weight: 600;
        }
        .split-panel {
            display: flex;
            gap: 2.5rem;
            flex-wrap: wrap;
        }
        .split-panel > div {
            flex: 1 1 350px;
        }
        .data-card {
            background: #f7ffee;
            border-radius: 32px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 3px solid #c7d392;
            box-shadow: 0 8px 0 #7a9865;
        }
        .data-card h2 {
            color: #1f6b1f;
            font-weight: 700;
            font-size: 1.9rem;
            border-bottom: 4px dotted #c2d17e;
            padding-bottom: 0.8rem;
            margin-bottom: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .field-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
        }
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .field label {
            font-weight: 800;
            color: #1b591b;
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        .field input, .field select, .field textarea {
            border: 3px solid #a5b77a;
            border-radius: 50px;
            padding: 12px 18px;
            font-size: 1rem;
            background: white;
        }
        .field input:focus, .field select:focus, .field textarea:focus {
            border-color: #479e47;
            box-shadow: 0 0 0 5px #c6ec9e;
            outline: none;
        }
        .checkbox-cluster {
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem 2rem;
            margin: 1.2rem 0 0.8rem;
        }
        .checkbox-cluster div {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-cluster input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: #3f9643;
        }
        .weather-panel {
            background: #e3f0cf;
            border-radius: 32px;
            padding: 1.8rem;
            margin: 1.5rem 0;
            border: 3px solid #bfc868;
            box-shadow: inset 0 2px 10px #f7ffd9, 0 7px 0 #61854b;
        }
        .weather-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.2rem;
            font-weight: 700;
            font-size: 1.2rem;
        }
        .manual-temp-card {
            background: #2d6d8a;
            color: white;
            border-radius: 80px;
            padding: 1.5rem 2.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 2rem;
            margin: 1.5rem 0;
            border: 4px solid #fad971;
        }
        .temp-item {
            text-align: center;
        }
        .temp-item .label {
            font-size: 0.9rem;
            text-transform: uppercase;
            opacity: 0.9;
        }
        .temp-item .value {
            font-size: 2.8rem;
            font-weight: 800;
            line-height: 1.2;
        }
        .temp-note {
            background: #fdebb3;
            padding: 0.5rem 1.5rem;
            border-radius: 60px;
            color: #1f4f1f;
            font-weight: 600;
            text-align: center;
        }
        .photo-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #e3f0cf;
            border-radius: 24px;
        }
        .photo-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #d4e3b5;
            border-radius: 20px;
        }
        .photo-preview-item {
            position: relative;
            width: 80px;
            text-align: center;
        }
        .photo-preview-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #8ba35e;
        }
        .photo-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #d16b4b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .photo-size {
            font-size: 0.7rem;
            color: #555;
            margin-top: 2px;
        }
        .template-buttons {
            display: flex;
            gap: 10px;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        .template-btn {
            background: #e9dba7;
            border: 2px solid #9c8b4b;
            padding: 8px 15px;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 600;
            color: #2f4f2f;
            font-size: 0.9rem;
        }
        .template-btn:hover {
            background: #f3e9b0;
        }
        .action-row {
            display: flex;
            gap: 1.5rem;
            justify-content: flex-end;
            margin: 2.5rem 0 1.8rem;
            flex-wrap: wrap;
        }
        .btn {
            background: white;
            border: 4px solid #467a33;
            padding: 14px 28px;
            border-radius: 70px;
            font-weight: 800;
            color: #1f561f;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }
        .btn-primary {
            background: #32853a;
            border-color: #f5bc3c;
            color: white;
            box-shadow: 0 6px 0 #1f591f;
        }
        .btn-excel {
            background: #1f7c3c;
            border-color: #f5bc3c;
            color: white;
            box-shadow: 0 6px 0 #175717;
        }
        .btn-save {
            background: #c47e2e;
            border-color: #f5bc3c;
            color: white;
            box-shadow: 0 6px 0 #7b4d1a;
        }
        .btn-csv {
            background: #4a6b8a;
            border-color: #f5bc3c;
            color: white;
            box-shadow: 0 6px 0 #2d4055;
        }
        .btn-primary:hover, .btn-excel:hover, .btn-save:hover, .btn-csv:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 0 #1f591f;
        }
        .btn-save:hover {
            background: #da973d;
        }
        .btn-csv:hover {
            background: #5a7b9a;
        }
        .btn:hover {
            background: #e4fbcb;
        }
        .records-section {
            background: #e3d8b0;
            border-radius: 32px;
            padding: 2rem;
            margin-top: 2rem;
            border: 3px solid #b7973a;
        }
        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .records-header h3 {
            color: #2d571d;
            font-size: 1.8rem;
            font-weight: 700;
        }
        .record-count {
            background: #528a44;
            color: white;
            padding: 0.4rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
        }
        .records-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.2rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 0.5rem 0.2rem;
        }
        .record-card {
            background: white;
            border-radius: 24px;
            padding: 1.2rem;
            border-left: 8px solid #4f8a4f;
            box-shadow: 0 4px 0 #af9f5a;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }
        .record-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 0 #af9f5a;
        }
        .record-card.selected {
            border-left: 8px solid #e5a526;
            background: #fff7df;
        }
        .record-date {
            font-weight: 700;
            color: #2d741d;
            font-size: 1.1rem;
        }
        .record-species {
            color: #3f4f2b;
            margin: 0.3rem 0;
        }
        .record-location {
            color: #626e44;
            font-size: 0.9rem;
        }
        .record-weather {
            background: #e5f0ce;
            border-radius: 30px;
            padding: 0.3rem 0.8rem;
            display: inline-block;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .record-photo-indicator {
            color: #b35e1a;
            font-size: 0.9rem;
            margin-top: 0.3rem;
        }
        .record-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.8rem;
            justify-content: flex-end;
        }
        .record-btn {
            background: none;
            border: 2px solid #8ba35e;
            padding: 0.3rem 1rem;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .record-btn.edit {
            background: #edb84a;
            border-color: #a57c2b;
            color: #2d421d;
        }
        .record-btn.delete {
            background: #d16b4b;
            border-color: #994f34;
            color: white;
        }
        .output-box {
            background: #1e3b1a;
            color: #e6ffb3;
            padding: 1.8rem;
            border-radius: 32px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 0.95rem;
            border: 4px solid #d6b556;
            margin-top: 1.8rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .weather-credit {
            font-size: 0.9rem;
            text-align: right;
            color: #4b7137;
            margin-top: 0.5rem;
            font-weight: 600;
        }
        .weather-note {
            background: #e9b53b;
            color: #1d481d;
            padding: 0.8rem;
            border-radius: 50px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .warnings-panel {
            background: #ffecb3;
            border: 3px solid #ffa000;
            border-radius: 20px;
            padding: 1rem;
            margin: 1rem 0;
            color: #b26500;
            font-weight: 600;
        }
        .camera-note {
            font-size: 0.85rem;
            color: #3a6b3a;
            margin: 5px 0;
            padding: 5px;
            background: #e8f5e8;
            border-radius: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="card">
    <div class="header">
        <h1>
            üå± FUTURE SEEDS PROGRAM 
            <span>DATA COLLECTOR v5.0</span>
        </h1>
        <div class="program-badge">‚ö° interactive map ¬∑ region selector ¬∑ manual weather ¬∑ camera ready</div>
    </div>

    <!-- User Guide Toggle -->
    <div class="guide-toggle" onclick="toggleGuide()">
        <span>üìñ</span> Show/Hide User Guide & Instructions
    </div>
    <div class="guide-panel" id="guidePanel">
        <div class="guide-grid">
            <div class="guide-step">
                <h3>üìç 1. Choose Location</h3>
                <ul>
                    <li><strong>Quick region:</strong> Use dropdown for broad area</li>
                    <li><strong>Your location:</strong> Click "Use My Location" button</li>
                    <li><strong>Precise:</strong> Click map or enter coordinates</li>
                    <li>Map automatically updates region</li>
                </ul>
            </div>
            <div class="guide-step">
                <h3>üìù 2. Enter Field Data</h3>
                <ul>
                    <li>Select species from dropdown</li>
                    <li>Record flowering stage and pollinators</li>
                    <li>Use templates for quick entry</li>
                    <li>Add site notes and fire history</li>
                </ul>
            </div>
            <div class="guide-step">
                <h3>üì∏ 3. Take Photos</h3>
                <ul>
                    <li><strong>Take Photo Now:</strong> Opens camera for new photos</li>
                    <li><strong>Choose from Gallery:</strong> Select existing photos</li>
                    <li>Photos are embedded in saved records</li>
                    <li>Large photos can be compressed</li>
                </ul>
            </div>
            <div class="guide-step">
                <h3>üå°Ô∏è 4. Manual Weather Entry</h3>
                <ul>
                    <li>Look up BOM data for your location</li>
                    <li>Enter ACTUAL min/max temperatures</li>
                    <li>Validation checks for unusual values</li>
                </ul>
            </div>
            <div class="guide-step">
                <h3>üíæ 5. Save & Export</h3>
                <ul>
                    <li>Save to local storage for later editing</li>
                    <li>Export as JSON, Excel, or CSV</li>
                    <li>Edit or delete existing records</li>
                    <li>View field statistics</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="region-bar">
        <div class="selector-group">
            <label>üåø Species:</label>
            <select id="speciesSelect" onchange="updateSpeciesInfo()">
                <option value="Acacia verticillata" selected>üåº Acacia verticillata (Prickly Moses) ‚Äî TEST SPECIES</option>
                <option value="Acacia dealbata">üåø Acacia dealbata (Silver Wattle)</option>
                <option value="Banksia marginata">ü™ª Banksia marginata (Silver Banksia)</option>
                <option value="Leptospermum scoparium">üå∏ Leptospermum scoparium (Manuka)</option>
                <option value="Nothofagus cunninghamii">üçÇ Nothofagus cunninghamii (Myrtle Beech)</option>
            </select>
        </div>
        <div class="location-options">
            <label>üìç Quick region:</label>
            <select id="regionSelect" onchange="updateFromRegion()">
                <option value="northWest">üåä North West (Burnie)</option>
                <option value="north">üå≤ North (Launceston)</option>
                <option value="south" selected>üèîÔ∏è South (Hobart)</option>
                <option value="westCoast">üåßÔ∏è West Coast (Strahan)</option>
            </select>
        </div>
    </div>

    <div class="content">
        <div class="current-conditions">
            <div class="species-info" id="speciesDisplay">üåº Acacia verticillata ‚Äî Prickly Moses</div>
            <div class="stats-panel" id="statsPanel">
                <div class="stat-item">üìä Total: <span class="stat-value" id="totalRecordsStat">0</span></div>
                <div class="stat-item">üå°Ô∏è Avg: <span class="stat-value" id="avgTempStat">-</span></div>
                <div class="stat-item" onclick="showFieldStats()" style="cursor: pointer;">üìà More Stats ‚Üí</div>
            </div>
            <div class="month-indicator" id="currentMonthDisplay">üìÜ February 2026 ¬∑ manual weather entry</div>
        </div>

        <!-- MAP SECTION -->
        <div class="map-section">
            <div class="map-header">
                <h3>üó∫Ô∏è Click map for precise location (or use location button)</h3>
                <div class="map-toggle">
                    <button class="map-btn location-btn" onclick="getUserLocation()">
                        üì± Use My Location
                    </button>
                    <button class="map-btn active" id="showMapBtn" onclick="toggleMap(true)">Show Map</button>
                    <button class="map-btn" id="hideMapBtn" onclick="toggleMap(false)">Hide Map</button>
                </div>
            </div>
            <div id="map" class="show"></div>
            <div class="coord-display">
                <div class="coord-item">
                    <label>Latitude:</label>
                    <input type="text" id="lat" value="-42.88" readonly>
                </div>
                <div class="coord-item">
                    <label>Longitude:</label>
                    <input type="text" id="lon" value="147.33" readonly>
                </div>
                <div class="coord-item">
                    <label>Detected region:</label>
                    <input type="text" id="detectedRegion" value="South (Hobart)" readonly>
                </div>
            </div>
        </div>

        <!-- TEMPLATE BUTTONS -->
        <div class="template-buttons">
            <button class="template-btn" onclick="applyTemplate('postFire')">üî• Post-fire Monitoring</button>
            <button class="template-btn" onclick="applyTemplate('peakFlower')">üå∏ Peak Flowering</button>
            <button class="template-btn" onclick="applyTemplate('seedCollection')">üå± Seed Collection</button>
            <button class="template-btn" onclick="applyTemplate('pollinatorSurvey')">üêù Pollinator Survey</button>
        </div>

        <div class="split-panel">
            <!-- LEFT: FLOWERING + POLLINATORS + PHOTOS -->
            <div>
                <div class="data-card">
                    <h2>üå∏ Flowering & pollinators</h2>
                    <div class="field-grid">
                        <div class="field">
                            <label>Observer</label>
                            <input type="text" id="observer" placeholder="full name" value="Lee">
                        </div>
                        <div class="field">
                            <label>Date</label>
                            <input type="date" id="obsDate" value="2026-02-26" onchange="updateMonthDisplay()">
                        </div>
                        <div class="field">
                            <label>Site name</label>
                            <input type="text" id="siteName" placeholder="e.g. Burnie coastal" value="Hobart Rivulet">
                        </div>
                    </div>

                    <div style="margin: 1.8rem 0 1rem;">
                        <label style="font-weight:800; color:#1f681f;">üåº Flowering stage</label>
                        <div class="checkbox-cluster">
                            <div><input type="checkbox" id="bud"> Bud</div>
                            <div><input type="checkbox" id="earlyFlower"> Early flower</div>
                            <div><input type="checkbox" id="fullFlower"> Full flower</div>
                            <div><input type="checkbox" id="petalFall"> Petal fall</div>
                            <div><input type="checkbox" id="seedPod"> Seed pod</div>
                        </div>
                    </div>

                    <div style="margin: 1.5rem 0;">
                        <label style="font-weight:800; color:#1f681f;">üêù Insect pollinators</label>
                        <div class="checkbox-cluster">
                            <div><input type="checkbox" id="honeybee"> Honeybee</div>
                            <div><input type="checkbox" id="nativeBee"> Native bee</div>
                            <div><input type="checkbox" id="fly"> Fly</div>
                            <div><input type="checkbox" id="beetle"> Beetle</div>
                            <div><input type="checkbox" id="wasp"> Wasp</div>
                            <div><input type="checkbox" id="butterfly"> Butterfly/moth</div>
                        </div>
                        <div class="field" style="margin-top:15px;">
                            <label>Other insects</label>
                            <textarea id="otherInsects" rows="2" placeholder="e.g. ants, thrips..."></textarea>
                        </div>
                    </div>

                    <!-- PHOTO SECTION with Camera Support -->
                    <div class="photo-section">
                        <label style="font-weight:800; color:#1f681f;">üì∏ Photo Documentation</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                            <!-- Camera button - opens camera directly -->
                            <button class="btn" onclick="openCamera()" style="background: #4a90e2; color: white; padding: 10px 20px; border-color: #2a5080;">
                                üì∑ Take Photo Now
                            </button>
                            
                            <!-- Hidden camera input -->
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                            
                            <!-- Gallery button - select existing photos -->
                            <button class="btn" onclick="document.getElementById('photoInput').click()" style="background: #8a6e4b; color: white; padding: 10px 20px;">
                                üñºÔ∏è Choose from Gallery
                            </button>
                            
                            <!-- Hidden gallery input -->
                            <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
                            
                            <span id="photoCount" style="align-self: center;">0 photos selected</span>
                        </div>
                        
                        <!-- Quick capture note -->
                        <div class="camera-note">
                            üì± On mobile: Camera opens automatically ‚Ä¢ On desktop: Select files
                        </div>
                        
                        <!-- Photo preview area -->
                        <div class="photo-preview" id="photoPreview"></div>
                        
                        <div style="font-size: 0.8rem; color: #5a7344; margin-top: 5px;">
                            ‚ö†Ô∏è Photos are stored as data URLs - large images may affect performance
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: SEED + FIRE + MANUAL WEATHER -->
            <div>
                <div class="data-card">
                    <h2>üå°Ô∏è MANUAL weather entry</h2>
                    
                    <div class="weather-note">
                        üîç Look up BOM data for your location and enter actual monthly values
                    </div>
                    
                    <div class="field-grid">
                        <div class="field">
                            <label>üå°Ô∏è Actual min temp (¬∞C)</label>
                            <input type="number" id="actualMinTemp" step="0.1" placeholder="e.g. 14.2" value="14.2" oninput="updateTempDisplay()">
                        </div>
                        <div class="field">
                            <label>üå°Ô∏è Actual max temp (¬∞C)</label>
                            <input type="number" id="actualMaxTemp" step="0.1" placeholder="e.g. 23.1" value="23.1" oninput="updateTempDisplay()">
                        </div>
                        <div class="field">
                            <label>üìç BOM station name</label>
                            <input type="text" id="bomStation" placeholder="e.g. Hobart Airport" value="Hobart (Ellerslie Road)">
                        </div>
                        <div class="field">
                            <label>üÜî Station ID (if known)</label>
                            <input type="text" id="stationId" placeholder="e.g. 094029" value="094029">
                        </div>
                    </div>

                    <div class="manual-temp-card" id="manualTempCard">
                        <div class="temp-item"><span class="label">entered min</span><div class="value" id="displayMin">14.2¬∞C</div></div>
                        <div class="temp-item"><span class="label">entered max</span><div class="value" id="displayMax">23.1¬∞C</div></div>
                    </div>
                    
                    <div class="temp-note">
                        ‚è±Ô∏è Enter the ACTUAL recorded min/max for this collection month
                    </div>

                    <div style="margin-top: 2rem;">
                        <div class="field">
                            <label>üå± Seed maturity</label>
                            <select id="seedMaturity">
                                <option value="green">Green / immature</option>
                                <option value="early" selected>Early filling</option>
                                <option value="mature">Mature / ready</option>
                                <option value="dispersed">Already dispersed</option>
                            </select>
                        </div>
                        <div class="field" style="margin-top:15px;">
                            <label>üî• Fire history</label>
                            <select id="fireHistory">
                                <option value="none">No known fire</option>
                                <option value="recent">Recent fire (<2 yrs)</option>
                                <option value="old">Old fire scar (>5 yrs)</option>
                                <option value="megafire" selected>Mega-fire footprint</option>
                            </select>
                        </div>
                        <div class="field" style="margin-top:15px;">
                            <label>üìù Site notes</label>
                            <textarea id="notes" rows="2" placeholder="plant health, fire damage, flowering density..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WARNINGS PANEL (hidden by default) -->
        <div id="warningsPanel" class="warnings-panel" style="display: none;"></div>

        <!-- ACTION BUTTONS -->
        <div class="action-row">
            <button class="btn" onclick="resetForm()">‚ü≤ Reset</button>
            <button class="btn btn-save" onclick="saveRecord()">üíæ Save to Local Storage</button>
            <button class="btn btn-primary" onclick="captureJSON()">üì• Export as JSON</button>
            <button class="btn btn-excel" onclick="exportToExcel()">üìä Export to Excel</button>
            <button class="btn btn-csv" onclick="exportToCSV()">üìÑ Export to CSV</button>
        </div>

        <!-- RECORDS SECTION -->
        <div class="records-section">
            <div class="records-header">
                <h3>üìã Saved Records</h3>
                <div class="record-count" id="recordCount">0 records</div>
                <button class="btn" onclick="clearAllRecords()" style="padding:8px 20px;">üóëÔ∏è Clear All</button>
            </div>
            <div class="records-grid" id="recordsGrid">
                <!-- Records will be populated here -->
            </div>
        </div>

        <!-- OUTPUT PREVIEW -->
        <div class="output-box" id="outputBox">
            ‚è∫ Dataset preview will appear here. Capture data to begin.
        </div>
        <div class="weather-credit">Enter actual BOM observations for correlation analysis</div>
    </div>
</div>

<script>
    // Month display names
    const monthDisplayNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    // Local storage key
    const STORAGE_KEY = 'futureSeedsRecords';

    // Load records from localStorage
    let savedRecords = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    // Region boundaries (accurate for Tasmania based on real geographic data)
    const regionBoundaries = {
        northWest: { 
            minLat: -41.6,    // Southern boundary (just south of Burnie)
            maxLat: -40.6,    // Northern boundary (tips of NW Tasmania)
            minLon: 144.6,    // Western boundary (west coast)
            maxLon: 146.0,    // Eastern boundary (just east of Burnie)
            name: "North West (Burnie)",
            center: { lat: -41.05, lon: 145.90 } // Burnie
        },
        north: { 
            minLat: -41.9,    // Southern boundary (just south of Launceston)
            maxLat: -41.0,    // Northern boundary (Bass Strait coast)
            minLon: 146.0,    // Western boundary (overlaps slightly with NW)
            maxLon: 148.0,    // Eastern boundary (east coast)
            name: "North (Launceston)",
            center: { lat: -41.43, lon: 147.14 } // Launceston
        },
        south: { 
            minLat: -43.7,    // Southern boundary (South East Cape)
            maxLat: -42.0,    // Northern boundary (just north of Hobart)
            minLon: 146.0,    // Western boundary (Mt Field area)
            maxLon: 148.3,    // Eastern boundary (east coast, Freycinet)
            name: "South (Hobart)",
            center: { lat: -42.88, lon: 147.33 } // Hobart
        },
        westCoast: { 
            minLat: -43.6,    // Southern boundary (South West Cape)
            maxLat: -41.5,    // Northern boundary (Pieman River area)
            minLon: 144.5,    // Western boundary (west coast)
            maxLon: 146.0,    // Eastern boundary (Lake St Clair area)
            name: "West Coast (Strahan)",
            center: { lat: -42.15, lon: 145.32 } // Strahan
        }
    };

    // Major city coordinates for fallback (more accurate)
    const majorCities = [
        { name: "North West (Burnie)", lat: -41.05, lon: 145.90, key: 'northWest' },
        { name: "North (Launceston)", lat: -41.43, lon: 147.14, key: 'north' },
        { name: "South (Hobart)", lat: -42.88, lon: 147.33, key: 'south' },
        { name: "West Coast (Strahan)", lat: -42.15, lon: 145.32, key: 'westCoast' },
        { name: "North West (Devonport)", lat: -41.18, lon: 146.36, key: 'northWest' }, // Additional NW city
        { name: "North (George Town)", lat: -41.10, lon: 146.82, key: 'north' } // Additional North city
    ];

    // Templates for quick entry
    const templates = {
        postFire: {
            fireHistory: 'recent',
            notes: 'Post-fire regeneration monitoring',
            seedMaturity: 'early',
        },
        peakFlower: {
            fullFlower: true,
            seedMaturity: 'early',
            notes: 'Peak flowering observed',
        },
        seedCollection: {
            seedPod: true,
            seedMaturity: 'mature',
            notes: 'Seed collection site',
        },
        pollinatorSurvey: {
            notes: 'Pollinator survey location',
        }
    };

    // Photo handling
    let selectedPhotos = [];

    // Initialize map
    let map;
    let marker;

    // Calculate distance between two points using Haversine formula
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Toggle guide
    function toggleGuide() {
        document.getElementById('guidePanel').classList.toggle('show');
    }

    // Toggle map visibility
    function toggleMap(show) {
        const mapEl = document.getElementById('map');
        const showBtn = document.getElementById('showMapBtn');
        const hideBtn = document.getElementById('hideMapBtn');
        
        if (show) {
            mapEl.classList.add('show');
            showBtn.classList.add('active');
            hideBtn.classList.remove('active');
            setTimeout(() => map.invalidateSize(), 100);
        } else {
            mapEl.classList.remove('show');
            showBtn.classList.remove('active');
            hideBtn.classList.add('active');
        }
    }

    // Get user location
    function getUserLocation() {
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser');
            return;
        }
        
        const outputBox = document.getElementById('outputBox');
        outputBox.innerText = 'üìç Getting your location...';
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                if (marker) {
                    marker.setLatLng([lat, lng]);
                    map.setView([lat, lng], 12);
                }
                
                updateCoordinates(lat, lng);
                reverseGeocode(lat, lng);
                
                outputBox.innerText = `üìç Location captured: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            },
            (error) => {
                let errorMessage = 'Location error: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Please allow location access';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'Location information unavailable';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'Location request timed out';
                        break;
                    default:
                        errorMessage += 'Unknown error';
                }
                alert(errorMessage);
                outputBox.innerText = '‚ùå ' + errorMessage;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    // Reverse geocoding to get location name
    function reverseGeocode(lat, lng) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
            .then(response => response.json())
            .then(data => {
                if (data.display_name) {
                    const locationParts = [];
                    if (data.address.suburb) locationParts.push(data.address.suburb);
                    if (data.address.town) locationParts.push(data.address.town);
                    if (data.address.city) locationParts.push(data.address.city);
                    if (data.address.state) locationParts.push(data.address.state);
                    
                    if (locationParts.length > 0) {
                        document.getElementById('siteName').value = locationParts.join(', ');
                    }
                }
            })
            .catch(error => console.log('Reverse geocoding failed:', error));
    }

    // Initialize map on load
    function initMap() {
        map = L.map('map').setView([-42.88, 147.33], 7);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        marker = L.marker([-42.88, 147.33], {
            draggable: true
        }).addTo(map);

        marker.on('dragend', function(e) {
            const latlng = marker.getLatLng();
            updateCoordinates(latlng.lat, latlng.lng);
        });

        map.on('click', function(e) {
            marker.setLatLng(e.latlng);
            updateCoordinates(e.latlng.lat, e.latlng.lng);
        });

        // Add region boundary overlays (optional - commented out)
        // addRegionBoundaries();
    }

    // Optional: Add visual region boundaries to map
    function addRegionBoundaries() {
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'];
        Object.values(regionBoundaries).forEach((bounds, index) => {
            const rectangle = L.rectangle([
                [bounds.minLat, bounds.minLon],
                [bounds.maxLat, bounds.maxLon]
            ], {
                color: colors[index % colors.length],
                weight: 2,
                opacity: 0.5,
                fillOpacity: 0.1
            }).addTo(map);
            
            // Add label at center
            L.marker([bounds.center.lat, bounds.center.lon], {
                icon: L.divIcon({ className: 'region-label', html: bounds.name.split(' ')[0] })
            }).addTo(map);
        });
    }

    // Update coordinates and region from map click with improved detection
    function updateCoordinates(lat, lng) {
        document.getElementById('lat').value = lat.toFixed(4);
        document.getElementById('lon').value = lng.toFixed(4);
        
        // First try exact boundary matching
        let detectedRegion = "Unknown";
        let matchedRegion = null;
        let matchedDistance = Infinity;
        
        for (const [key, bounds] of Object.entries(regionBoundaries)) {
            if (lat >= bounds.minLat && lat <= bounds.maxLat && 
                lng >= bounds.minLon && lng <= bounds.maxLon) {
                detectedRegion = bounds.name;
                matchedRegion = key;
                break;
            }
        }
        
        // If no exact match, find closest region based on distance to centers
        if (detectedRegion === "Unknown") {
            let closestDistance = Infinity;
            
            for (const [key, bounds] of Object.entries(regionBoundaries)) {
                const distance = calculateDistance(lat, lng, bounds.center.lat, bounds.center.lon);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    detectedRegion = bounds.name;
                    matchedRegion = key;
                }
            }
        }
        
        document.getElementById('detectedRegion').value = detectedRegion;
        if (matchedRegion) {
            document.getElementById('regionSelect').value = matchedRegion;
        }
    }

    // Update from region dropdown with improved coordinates
    function updateFromRegion() {
        const region = document.getElementById('regionSelect').value;
        
        // Get the center coordinates for selected region
        const bounds = regionBoundaries[region];
        
        document.getElementById('lat').value = bounds.center.lat.toFixed(4);
        document.getElementById('lon').value = bounds.center.lon.toFixed(4);
        document.getElementById('detectedRegion').value = bounds.name;
        
        if (marker) {
            marker.setLatLng([bounds.center.lat, bounds.center.lon]);
            map.setView([bounds.center.lat, bounds.center.lon], 9);
        }
    }

    // Get current month index
    function getCurrentMonthIndex() {
        const dateStr = document.getElementById('obsDate').value;
        if (dateStr) {
            const d = new Date(dateStr + 'T12:00:00');
            return d.getMonth();
        }
        return 1;
    }

    // Update month display
    function updateMonthDisplay() {
        const monthIndex = getCurrentMonthIndex();
        document.getElementById('currentMonthDisplay').innerHTML = `üìÜ ${monthDisplayNames[monthIndex]} 2026 ¬∑ manual weather entry`;
    }

    // Update temperature display
    function updateTempDisplay() {
        const minTemp = document.getElementById('actualMinTemp').value || '14.2';
        const maxTemp = document.getElementById('actualMaxTemp').value || '23.1';
        document.getElementById('displayMin').innerText = minTemp + '¬∞C';
        document.getElementById('displayMax').innerText = maxTemp + '¬∞C';
    }

    // Update species info
    function updateSpeciesInfo() {
        const select = document.getElementById('speciesSelect');
        const species = select.value;
        let displayName = species;
        if (species === 'Acacia verticillata') displayName = 'üåº Acacia verticillata (Prickly Moses) ‚Äî TEST SPECIES';
        else if (species === 'Acacia dealbata') displayName = 'üåø Acacia dealbata (Silver Wattle)';
        else if (species === 'Banksia marginata') displayName = 'ü™ª Banksia marginata (Silver Banksia)';
        else if (species === 'Leptospermum scoparium') displayName = 'üå∏ Leptospermum scoparium (Manuka)';
        else if (species === 'Nothofagus cunninghamii') displayName = 'üçÇ Nothofagus cunninghamii (Myrtle Beech)';
        document.getElementById('speciesDisplay').innerHTML = displayName;
    }

    // Open camera for taking new photos
    function openCamera() {
        const cameraInput = document.getElementById('cameraInput');
        
        // Set attributes for better camera handling
        cameraInput.setAttribute('capture', 'environment');
        cameraInput.setAttribute('accept', 'image/*');
        
        // Clear previous value to ensure change event fires
        cameraInput.value = '';
        
        // Trigger camera
        cameraInput.click();
        
        // Handle the captured photo
        cameraInput.onchange = function(e) {
            if (e.target.files && e.target.files[0]) {
                handleNewPhotos(Array.from(e.target.files));
            }
        };
    }

    // Handle new photos (from camera or gallery)
    function handleNewPhotos(newFiles) {
        // Add new files to existing selection
        const allFiles = [...selectedPhotos, ...newFiles];
        
        // Limit total photos to prevent storage issues
        const MAX_PHOTOS = 10;
        if (allFiles.length > MAX_PHOTOS) {
            alert(`Maximum ${MAX_PHOTOS} photos allowed. Only the first ${MAX_PHOTOS} will be kept.`);
            selectedPhotos = allFiles.slice(0, MAX_PHOTOS);
        } else {
            selectedPhotos = allFiles;
        }
        
        // Update UI
        document.getElementById('photoCount').innerText = `${selectedPhotos.length} photo(s) selected`;
        updatePhotoPreviews();
        
        // Check for large files and offer compression
        const largeFiles = selectedPhotos.filter(f => f.size > 5 * 1024 * 1024); // >5MB
        if (largeFiles.length > 0) {
            if (confirm('Some photos are large (>5MB). Would you like to compress them for better storage?')) {
                compressPhotos(largeFiles);
            }
        }
    }

    // Update photo previews
    function updatePhotoPreviews() {
        const previewDiv = document.getElementById('photoPreview');
        previewDiv.innerHTML = '';
        
        selectedPhotos.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.createElement('div');
                preview.className = 'photo-preview-item';
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button class="photo-remove" onclick="removePhoto(${index})">√ó</button>
                    <div class="photo-size">${(file.size / 1024).toFixed(0)}KB</div>
                `;
                previewDiv.appendChild(preview);
            };
            reader.readAsDataURL(file);
        });
    }

    // Remove photo
    function removePhoto(index) {
        selectedPhotos.splice(index, 1);
        document.getElementById('photoCount').innerText = `${selectedPhotos.length} photo(s) selected`;
        updatePhotoPreviews();
    }

    // Compress large photos
    function compressPhotos(files) {
        files.forEach((file, idx) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Create canvas for compression
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Max dimensions
                    const MAX_WIDTH = 1200;
                    const MAX_HEIGHT = 1200;
                    
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to compressed JPEG
                    canvas.toBlob((blob) => {
                        const compressedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        
                        // Replace the original file with compressed version
                        const fileIndex = selectedPhotos.indexOf(file);
                        if (fileIndex !== -1) {
                            selectedPhotos[fileIndex] = compressedFile;
                            updatePhotoPreviews();
                        }
                    }, 'image/jpeg', 0.8); // 80% quality
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // Gallery photo selection
    document.getElementById('photoInput').addEventListener('change', function(e) {
        if (e.target.files && e.target.files.length > 0) {
            handleNewPhotos(Array.from(e.target.files));
        }
    });

    // Apply template
    function applyTemplate(templateName) {
        const template = templates[templateName];
        
        if (template.fireHistory) document.getElementById('fireHistory').value = template.fireHistory;
        if (template.notes) document.getElementById('notes').value = template.notes;
        if (template.seedMaturity) document.getElementById('seedMaturity').value = template.seedMaturity;
        
        // Flowering checkboxes
        if (template.fullFlower) document.getElementById('fullFlower').checked = true;
        if (template.seedPod) document.getElementById('seedPod').checked = true;
        
        document.getElementById('outputBox').innerText = `‚úÖ Applied template: ${templateName}`;
    }

    // Validate form
    function validateForm() {
        const warnings = [];
        
        const lat = parseFloat(document.getElementById('lat').value);
        const lon = parseFloat(document.getElementById('lon').value);
        if (lat < -43.7 || lat > -40.4 || lon < 144.5 || lon > 148.5) {
            warnings.push('‚ö†Ô∏è Coordinates appear outside Tasmania');
        }
        
        const minTemp = parseFloat(document.getElementById('actualMinTemp').value);
        const maxTemp = parseFloat(document.getElementById('actualMaxTemp').value);
        if (minTemp < -10 || minTemp > 30) {
            warnings.push('‚ö†Ô∏è Min temperature seems unusual for Tasmania');
        }
        if (maxTemp < 0 || maxTemp > 45) {
            warnings.push('‚ö†Ô∏è Max temperature seems unusual for Tasmania');
        }
        
        const obsDate = new Date(document.getElementById('obsDate').value);
        if (obsDate.getFullYear() !== 2026) {
            warnings.push('‚ö†Ô∏è Collection date is not in 2026');
        }
        
        // Check if any flowering stage is selected
        const floweringSelected = [
            'bud', 'earlyFlower', 'fullFlower', 'petalFall', 'seedPod'
        ].some(id => document.getElementById(id).checked);
        
        if (!floweringSelected) {
            warnings.push('‚ö†Ô∏è No flowering stage selected');
        }
        
        return warnings;
    }

    // Show warnings
    function showWarnings(warnings) {
        const panel = document.getElementById('warningsPanel');
        if (warnings.length > 0) {
            panel.style.display = 'block';
            panel.innerHTML = '‚ö†Ô∏è Validation Warnings:<br>' + warnings.join('<br>');
        } else {
            panel.style.display = 'none';
        }
    }

    // Collect form data
    function collectFormData() {
        const region = document.getElementById('regionSelect').value;
        const regionNames = {
            northWest: "North West (Burnie)",
            north: "North (Launceston)",
            south: "South (Hobart)",
            westCoast: "West Coast (Strahan)"
        };
        
        const monthIndex = getCurrentMonthIndex();
        const monthName = monthDisplayNames[monthIndex];

        return {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            program: "Future Seeds Program",
            observer: document.getElementById('observer').value,
            collectionDate: document.getElementById('obsDate').value,
            species: document.getElementById('speciesSelect').value,
            location: {
                region: regionNames[region],
                detectedRegion: document.getElementById('detectedRegion').value,
                siteName: document.getElementById('siteName').value,
                latitude: parseFloat(document.getElementById('lat').value),
                longitude: parseFloat(document.getElementById('lon').value),
                coordinateSource: "Map click / manual"
            },
            phenology: {
                flowering: {
                    bud: document.getElementById('bud').checked,
                    earlyFlower: document.getElementById('earlyFlower').checked,
                    fullFlower: document.getElementById('fullFlower').checked,
                    petalFall: document.getElementById('petalFall').checked,
                    seedPod: document.getElementById('seedPod').checked
                },
                pollinators: {
                    honeybee: document.getElementById('honeybee').checked,
                    nativeBee: document.getElementById('nativeBee').checked,
                    fly: document.getElementById('fly').checked,
                    beetle: document.getElementById('beetle').checked,
                    wasp: document.getElementById('wasp').checked,
                    butterfly: document.getElementById('butterfly').checked,
                    other: document.getElementById('otherInsects').value
                },
                seedMaturity: document.getElementById('seedMaturity').value
            },
            siteHistory: {
                fire: document.getElementById('fireHistory').value,
                notes: document.getElementById('notes').value
            },
            weather: {
                month: monthName,
                year: 2026,
                minTemp: parseFloat(document.getElementById('actualMinTemp').value) || null,
                maxTemp: parseFloat(document.getElementById('actualMaxTemp').value) || null,
                station: document.getElementById('bomStation').value,
                stationId: document.getElementById('stationId').value,
                dataType: "Manual BOM entry",
                notes: "User-entered actual observations"
            },
            photos: selectedPhotos.map(file => ({
                name: file.name,
                type: file.type,
                size: file.size
                // Note: actual photo data not included in JSON preview to keep it clean
            }))
        };
    }

    // Save record to localStorage
    function saveRecord() {
        updateTempDisplay();
        
        const warnings = validateForm();
        showWarnings(warnings);
        
        if (warnings.length > 0) {
            if (!confirm('‚ö†Ô∏è Validation warnings found.\n\n' + warnings.join('\n') + '\n\nSave anyway?')) {
                return;
            }
        }
        
        const data = collectFormData();
        
        // Add photos as base64 for storage
        const photoPromises = selectedPhotos.map(file => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                };
                reader.readAsDataURL(file);
            });
        });
        
        Promise.all(photoPromises).then(photoData => {
            data.photos = photoData;
            savedRecords.push(data);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedRecords));
            displayRecords();
            updateStats();
            document.getElementById('outputBox').innerText = '‚úÖ Record saved to local storage!\n\n' + 
                JSON.stringify({...data, photos: `${data.photos.length} photo(s)`}, null, 2);
        });
    }

    // Display records in grid
    function displayRecords() {
        const grid = document.getElementById('recordsGrid');
        const countEl = document.getElementById('recordCount');
        
        if (savedRecords.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:#5f7344;">No saved records yet. Complete and save your first observation!</div>';
            countEl.innerText = '0 records';
            return;
        }

        countEl.innerText = `${savedRecords.length} record${savedRecords.length !== 1 ? 's' : ''}`;
        
        grid.innerHTML = savedRecords.map((record, index) => `
            <div class="record-card" onclick="selectRecord(${index})">
                <div class="record-date">üìÖ ${record.collectionDate}</div>
                <div class="record-species">üåø ${record.species.split(' ')[0]} ${record.species.split(' ')[1] || ''}</div>
                <div class="record-location">üìç ${record.location.region}</div>
                <div class="record-weather">üå°Ô∏è ${record.weather.minTemp}¬∞C / ${record.weather.maxTemp}¬∞C</div>
                ${record.photos && record.photos.length > 0 ? 
                    `<div class="record-photo-indicator">üì∏ ${record.photos.length} photo(s)</div>` : ''}
                <div class="record-actions">
                    <button class="record-btn edit" onclick="event.stopPropagation(); editRecord(${index})">‚úèÔ∏è Edit</button>
                    <button class="record-btn delete" onclick="event.stopPropagation(); deleteRecord(${index})">üóëÔ∏è Delete</button>
                </div>
            </div>
        `).join('');
    }

    // Select record to view
    function selectRecord(index) {
        const record = savedRecords[index];
        const displayRecord = {...record};
        if (displayRecord.photos) {
            displayRecord.photos = `${displayRecord.photos.length} photo(s)`;
        }
        document.getElementById('outputBox').innerText = JSON.stringify(displayRecord, null, 2);
        
        const cards = document.querySelectorAll('.record-card');
        cards.forEach(c => c.classList.remove('selected'));
        cards[index]?.classList.add('selected');
    }

    // Edit record - load into form
    function editRecord(index) {
        const record = savedRecords[index];
        
        document.getElementById('observer').value = record.observer;
        document.getElementById('obsDate').value = record.collectionDate;
        document.getElementById('siteName').value = record.location.siteName;
        document.getElementById('lat').value = record.location.latitude;
        document.getElementById('lon').value = record.location.longitude;
        
        document.getElementById('speciesSelect').value = record.species;
        updateSpeciesInfo();
        
        const regionMap = {
            'North West (Burnie)': 'northWest',
            'North (Launceston)': 'north',
            'South (Hobart)': 'south',
            'West Coast (Strahan)': 'westCoast'
        };
        document.getElementById('regionSelect').value = regionMap[record.location.region] || 'south';
        document.getElementById('detectedRegion').value = record.location.region;
        
        document.getElementById('bud').checked = record.phenology.flowering.bud;
        document.getElementById('earlyFlower').checked = record.phenology.flowering.earlyFlower;
        document.getElementById('fullFlower').checked = record.phenology.flowering.fullFlower;
        document.getElementById('petalFall').checked = record.phenology.flowering.petalFall;
        document.getElementById('seedPod').checked = record.phenology.flowering.seedPod;
        
        document.getElementById('honeybee').checked = record.phenology.pollinators.honeybee;
        document.getElementById('nativeBee').checked = record.phenology.pollinators.nativeBee;
        document.getElementById('fly').checked = record.phenology.pollinators.fly;
        document.getElementById('beetle').checked = record.phenology.pollinators.beetle;
        document.getElementById('wasp').checked = record.phenology.pollinators.wasp;
        document.getElementById('butterfly').checked = record.phenology.pollinators.butterfly;
        document.getElementById('otherInsects').value = record.phenology.pollinators.other;
        
        document.getElementById('actualMinTemp').value = record.weather.minTemp;
        document.getElementById('actualMaxTemp').value = record.weather.maxTemp;
        document.getElementById('bomStation').value = record.weather.station || '';
        document.getElementById('stationId').value = record.weather.stationId || '';
        
        document.getElementById('seedMaturity').value = record.phenology.seedMaturity;
        document.getElementById('fireHistory').value = record.siteHistory.fire;
        document.getElementById('notes').value = record.siteHistory.notes;
        
        // Clear photos (can't easily restore from base64)
        selectedPhotos = [];
        document.getElementById('photoPreview').innerHTML = '';
        document.getElementById('photoCount').innerText = '0 photos selected';
        
        updateMonthDisplay();
        updateTempDisplay();
        
        if (marker) {
            marker.setLatLng([record.location.latitude, record.location.longitude]);
            map.setView([record.location.latitude, record.location.longitude], 8);
        }
        
        document.getElementById('outputBox').innerText = `‚úèÔ∏è Editing record from ${record.collectionDate}\n\nMake changes and click "Save to Local Storage" to update.`;
        
        deleteRecord(index, true);
    }

    // Delete record
    function deleteRecord(index, silent = false) {
        savedRecords.splice(index, 1);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedRecords));
        displayRecords();
        updateStats();
        if (!silent) {
            document.getElementById('outputBox').innerText = 'üóëÔ∏è Record deleted.';
        }
    }

    // Clear all records
    function clearAllRecords() {
        if (confirm('Are you sure you want to delete ALL saved records?')) {
            savedRecords = [];
            localStorage.removeItem(STORAGE_KEY);
            displayRecords();
            updateStats();
            document.getElementById('outputBox').innerText = 'üóëÔ∏è All records cleared.';
        }
    }

    // Update statistics
    function updateStats() {
        document.getElementById('totalRecordsStat').innerText = savedRecords.length;
        
        if (savedRecords.length > 0) {
            const avgMin = savedRecords.reduce((sum, r) => sum + (r.weather.minTemp || 0), 0) / savedRecords.length;
            const avgMax = savedRecords.reduce((sum, r) => sum + (r.weather.maxTemp || 0), 0) / savedRecords.length;
            document.getElementById('avgTempStat').innerHTML = `${avgMin.toFixed(1)}/${avgMax.toFixed(1)}¬∞C`;
        }
    }

    // Show field statistics
    function showFieldStats() {
        const stats = {
            totalRecords: savedRecords.length,
            uniqueSites: new Set(savedRecords.map(r => r.location.siteName)).size,
            speciesCount: new Set(savedRecords.map(r => r.species)).size,
            regions: {},
            fireHistory: {},
            totalPhotos: savedRecords.reduce((sum, r) => sum + (r.photos?.length || 0), 0)
        };
        
        savedRecords.forEach(r => {
            stats.regions[r.location.region] = (stats.regions[r.location.region] || 0) + 1;
            stats.fireHistory[r.siteHistory.fire] = (stats.fireHistory[r.siteHistory.fire] || 0) + 1;
        });
        
        document.getElementById('outputBox').innerText = 'üìä Field Statistics:\n\n' +
            `Total Records: ${stats.totalRecords}\n` +
            `Unique Sites: ${stats.uniqueSites}\n` +
            `Species Count: ${stats.speciesCount}\n` +
            `Total Photos: ${stats.totalPhotos}\n\n` +
            `Records by Region:\n${Object.entries(stats.regions).map(([r, c]) => `  ${r}: ${c}`).join('\n')}\n\n` +
            `Fire History:\n${Object.entries(stats.fireHistory).map(([f, c]) => `  ${f}: ${c}`).join('\n')}`;
    }

    // JSON export
    function captureJSON() {
        updateTempDisplay();
        const data = collectFormData();
        document.getElementById('outputBox').innerText = JSON.stringify(data, null, 2);
    }

    // Excel export
    function exportToExcel() {
        updateTempDisplay();
        const data = collectFormData();
        
        const flatData = {
            'Program': data.program,
            'Observer': data.observer,
            'Collection Date': data.collectionDate,
            'Species': data.species,
            'Region': data.location.region,
            'Detected Region': data.location.detectedRegion,
            'Site': data.location.siteName,
            'Latitude': data.location.latitude,
            'Longitude': data.location.longitude,
            'Flowering - Bud': data.phenology.flowering.bud,
            'Flowering - Early': data.phenology.flowering.earlyFlower,
            'Flowering - Full': data.phenology.flowering.fullFlower,
            'Flowering - Petal Fall': data.phenology.flowering.petalFall,
            'Flowering - Seed Pod': data.phenology.flowering.seedPod,
            'Pollinators - Honeybee': data.phenology.pollinators.honeybee,
            'Pollinators - Native Bee': data.phenology.pollinators.nativeBee,
            'Pollinators - Fly': data.phenology.pollinators.fly,
            'Pollinators - Beetle': data.phenology.pollinators.beetle,
            'Pollinators - Wasp': data.phenology.pollinators.wasp,
            'Pollinators - Butterfly/Moth': data.phenology.pollinators.butterfly,
            'Pollinators - Other': data.phenology.pollinators.other,
            'Seed Maturity': data.phenology.seedMaturity,
            'Fire History': data.siteHistory.fire,
            'Site Notes': data.siteHistory.notes,
            'Weather Month': data.weather.month,
            'Weather Year': data.weather.year,
            'Actual Min Temp (¬∞C)': data.weather.minTemp,
            'Actual Max Temp (¬∞C)': data.weather.maxTemp,
            'BOM Station': data.weather.station,
            'Station ID': data.weather.stationId,
            'Photo Count': selectedPhotos.length,
            'Record Timestamp': data.timestamp
        };

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet([flatData]);
        XLSX.utils.book_append_sheet(wb, ws, "Future Seeds Data");
        
        const dateStr = data.collectionDate.replace(/-/g, '');
        const filename = `Future_Seeds_${data.species.replace(/\s/g, '_')}_${dateStr}.xlsx`;
        
        XLSX.writeFile(wb, filename);
        
        document.getElementById('outputBox').innerText = `‚úÖ Excel file exported: ${filename}`;
    }

    // CSV export
    function exportToCSV() {
        updateTempDisplay();
        const data = collectFormData();
        
        const flatData = {
            'Program': data.program,
            'Observer': data.observer,
            'Collection Date': data.collectionDate,
            'Species': data.species,
            'Region': data.location.region,
            'Site': data.location.siteName,
            'Latitude': data.location.latitude,
            'Longitude': data.location.longitude,
            'Min Temp': data.weather.minTemp,
            'Max Temp': data.weather.maxTemp,
            'Fire History': data.siteHistory.fire,
            'Notes': data.siteHistory.notes
        };
        
        const headers = Object.keys(flatData).join(',');
        const values = Object.values(flatData).map(v => 
            typeof v === 'string' && v.includes(',') ? `"${v}"` : v
        ).join(',');
        
        const csv = headers + '\n' + values;
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `data_${data.collectionDate}.csv`;
        a.click();
        
        document.getElementById('outputBox').innerText = `‚úÖ CSV file exported`;
    }

    // Reset form
    function resetForm() {
        document.getElementById('observer').value = 'Lee';
        document.getElementById('obsDate').value = '2026-02-26';
        document.getElementById('siteName').value = 'Hobart Rivulet';
        document.getElementById('lat').value = '-42.88';
        document.getElementById('lon').value = '147.33';
        document.getElementById('detectedRegion').value = 'South (Hobart)';
        document.getElementById('bud').checked = false;
        document.getElementById('earlyFlower').checked = false;
        document.getElementById('fullFlower').checked = false;
        document.getElementById('petalFall').checked = false;
        document.getElementById('seedPod').checked = false;
        document.getElementById('honeybee').checked = false;
        document.getElementById('nativeBee').checked = false;
        document.getElementById('fly').checked = false;
        document.getElementById('beetle').checked = false;
        document.getElementById('wasp').checked = false;
        document.getElementById('butterfly').checked = false;
        document.getElementById('otherInsects').value = '';
        document.getElementById('actualMinTemp').value = '14.2';
        document.getElementById('actualMaxTemp').value = '23.1';
        document.getElementById('bomStation').value = 'Hobart (Ellerslie Road)';
        document.getElementById('stationId').value = '094029';
        document.getElementById('seedMaturity').value = 'early';
        document.getElementById('fireHistory').value = 'megafire';
        document.getElementById('notes').value = '';
        document.getElementById('speciesSelect').value = 'Acacia verticillata';
        document.getElementById('regionSelect').value = 'south';
        
        // Clear photos
        selectedPhotos = [];
        document.getElementById('photoPreview').innerHTML = '';
        document.getElementById('photoCount').innerText = '0 photos selected';
        
        updateSpeciesInfo();
        updateMonthDisplay();
        updateTempDisplay();
        showWarnings([]);
        
        if (marker) {
            marker.setLatLng([-42.88, 147.33]);
            map.setView([-42.88, 147.33], 7);
        }
        
        document.getElementById('outputBox').innerText = '‚è∫ Form reset. Ready for new capture.';
        document.querySelectorAll('.record-card').forEach(c => c.classList.remove('selected'));
    }

    // Initialize on load
    window.onload = function() {
        initMap();
        updateSpeciesInfo();
        updateMonthDisplay();
        updateTempDisplay();
        displayRecords();
        updateStats();
    };
</script>
</body>
</html>
